<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ã‚µãƒ ãƒ©ã‚¤ã‚¢ãƒƒãƒ—ãƒ«</title>
<style>
  :root{
    --bg:#f7f8fc; --panel:#ffffff; --text:#111827; --muted:#4b5563;
    /* ğŸ ãƒªãƒ³ã‚´è‰² */
    --apple:#ef4444;      /* æœ¬ä½“ã®èµ¤ */
    --appleEdge:#7f1d1d;  /* ç¸ã®æ¿ƒã„èµ¤ */
    --leaf:#16a34a;       /* è‘‰ã®ç·‘ */
    --stem:#6b4f1d;       /* ãƒ˜ã‚¿ã®èŒ¶ */
    --slash:#ef4444;
    --border:#e5e7eb; --shadow:0 6px 18px rgba(0,0,0,.07);
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Sans","Yu Gothic UI",sans-serif;
    overflow:hidden; touch-action:none; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ */
  }
  header{
    height:44px; padding:8px 12px; border-bottom:1px solid var(--border); background:var(--panel);
    display:flex; align-items:center; justify-content:space-between; gap:10px; box-shadow:var(--shadow)
  }
  h1{margin:0; font-size:16px; white-space:nowrap}
  .score{
    font-weight:800; background:#f3f4f6; border:1px solid var(--border); color:#111827;
    padding:4px 8px; border-radius:999px; font-variant-numeric:tabular-nums; font-size:13px;
  }
  main{
    height:calc(100dvh - 44px);
    max-width:980px; margin:0 auto; padding:8px; display:flex; flex-direction:column;
  }
  .stage{
    position:relative; flex:1; border:1px solid var(--border); border-radius:12px; overflow:hidden;
    background:linear-gradient(180deg,#ffffff,#f6f7fb); box-shadow:var(--shadow)
  }
  canvas{width:100%; height:100%; display:block}

  /* START/RESTARTï¼šç„¡è£…é£¾ãƒœã‚¿ãƒ³ã®ã¿ */
  .overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
  }
  .overlay .plain{
    pointer-events:auto; background:transparent; border:1px solid #111; color:#111;
    padding:10px 18px; font-weight:800; border-radius:8px; cursor:pointer;
    touch-action:manipulation;
  }
  .overlay.hidden{display:none}

  /* ãƒŸã‚¹è¡¨ç¤ºï¼ˆå°ã•ãï¼‰ */
  .hud{
    position:absolute; left:8px; top:8px; color:var(--muted); font-size:12px; background:rgba(255,255,255,.66);
    padding:3px 6px; border-radius:8px; border:1px solid var(--border)
  }
</style>
</head>
<body>
  <header>
    <h1>ã‚µãƒ ãƒ©ã‚¤ã‚¢ãƒƒãƒ—ãƒ«</h1>
    <div class="score">SCORE: <span id="score">0</span></div>
  </header>

  <main>
    <section class="stage" id="stage">
      <canvas id="game" width="720" height="1080" aria-label="ã‚²ãƒ¼ãƒ ç”»é¢"></canvas>

      <div id="hud" class="hud">MISS: <span id="miss">0</span>/3</div>

      <div id="overlay" class="overlay" role="dialog" aria-modal="true">
        <button id="btnStart" class="plain" type="button" aria-label="é–‹å§‹">START</button>
      </div>
    </section>
  </main>

<script>
/* ========= ç”»é¢/çŠ¶æ…‹ ========= */
let state='idle', starting=false, lastT=0;

const stage   = document.getElementById('stage');
const canvas  = document.getElementById('game');
const ctx     = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const missEl  = document.getElementById('miss');
const overlay = document.getElementById('overlay');
const startBtn= document.getElementById('btnStart');

/* â˜… ã‚²ãƒ¼ãƒ åº§æ¨™ã¯ CSS ãƒ”ã‚¯ã‚»ãƒ«ã§çµ±ä¸€ï¼ˆæç”»ã®ã¿DPRå¯¾å¿œï¼‰ */
let viewW = 720, viewH = 1080, dpr = 1;

function fitCanvas(){
  const rect = stage.getBoundingClientRect();
  dpr = Math.min(window.devicePixelRatio||1, 2);
  canvas.width  = Math.max(360, Math.floor(rect.width  * dpr));
  canvas.height = Math.max(480, Math.floor(rect.height * dpr));
  canvas.style.width  = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);   // æç”»ã ã‘é«˜DPI
  viewW = rect.width; viewH = rect.height; // ãƒ­ã‚¸ãƒƒã‚¯ã¯CSS px
  onResize();
}
addEventListener('resize', fitCanvas, {passive:true});

/* ========= çŠ¶æ…‹é·ç§» ========= */
function toPlaying(){
  state='playing';
  overlay.classList.add('hidden');
  // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ åˆæœŸåŒ–
  score=0; misses=0; elapsed=0; updateHUD();
  apples.length=particles.length=recentSegments.length=slashTrail.length=0;
  spawnTimer=0; nextSpawn=pickNextSpawn(); lastCutAt=0; combo=0;
}
function toGameOver(){
  state='gameover';
  overlay.classList.remove('hidden');
  startBtn.textContent='RESTART';
}
function fullReset(){
  state='idle'; starting=false; lastT=0;
  fitCanvas();
  initGameObjects();
  startBtn.textContent='START';
  overlay.classList.remove('hidden');
  updateHUD();
}
function safeStart(){
  if(starting||state==='playing') return;
  starting=true; fullReset(); toPlaying();
  setTimeout(()=>{ starting=false; }, 120); // å¤šé‡ã‚¿ãƒƒãƒ—å¸å
}
function onBtn(e){ e?.preventDefault?.(); e?.stopPropagation?.(); safeStart(); }
startBtn.addEventListener('click', onBtn);
startBtn.addEventListener('pointerdown', onBtn);
startBtn.addEventListener('touchstart', onBtn, {passive:false});
canvas.addEventListener('pointerdown', e=>{ if(state!=='playing') onBtn(e); });

/* ========= è¨­å®š ========= */
const CFG = {
  // ã‚µã‚¤ã‚ºï¼ˆãƒªãƒ³ã‚´åŠå¾„ã®åŸºæº–ï¼‰
  sizeMin: 28, sizeMax: 36,

  // ç‰©ç†ï¼ˆãªã‚ã‚‰ã‹åŠ é€Ÿã«æœ€é©åŒ–ï¼‰
  gravityBase: 820,                 // åˆæœŸé‡åŠ›
  gravityMaxBoost: 0.8,             // é‡åŠ›å€ç‡ã®æœ€å¤§ä¸Šæ˜‡é‡ï¼ˆ+80%ã¾ã§ï¼‰
  baseVyMin: 150, baseVyMax: 210,   // åˆé€Ÿã®åŸºæº–
  vyMaxBoost: 0.5,                  // åˆé€Ÿå€ç‡ã®æœ€å¤§ä¸Šæ˜‡é‡ï¼ˆ+50%ã¾ã§ï¼‰

  vxRand: 140,
  spinMin: -1.6, spinMax: 1.6,      // ãƒªãƒ³ã‚´ã¯ã‚ã¾ã‚Šå›è»¢ã•ã›ãªã„

  // ã‚¹ãƒãƒ¼ãƒ³ï¼ˆé–“éš”çŸ­ç¸®ã‚‚ãªã ã‚‰ã‹ï¼‰
  spawnMin: 520, spawnMax: 1200,
  spawnMinLimit: 320,

  // ã‚²ãƒ¼ãƒ åˆ¶ç´„
  maxMiss: 3,
  scoreBase: 10,
  comboWindow: 600,
  sliceWidth: 7,
  trailFadeMs: 220,
  segmentKeepMs: 120,
  particleN: 14,

  // ç«¯ã§è·³ã­è¿”ã‚Šï¼ˆç”»é¢å¤–ã«å‡ºã•ãªã„ï¼‰
  bounceDampen: 0.6,
  sideMargin: 4
};

/* â˜… â€œãªã‚ã‚‰ã‹åŠ é€Ÿâ€é–¢æ•°ï¼š0â†’1ã«é£½å’Œã™ã‚‹æ›²ç·šï¼ˆæŒ‡æ•°ç·©å’Œï¼‰ */
function smooth01(x, k=40){ return 1 - Math.exp(-x / k); }
/* é€Ÿåº¦ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ1.0ã€œ1.0+maxBoost ã¾ã§ç·©ã‚„ã‹ã«å¢—åŠ ï¼‰ */
function speedScale(score, maxBoost){
  return 1 + maxBoost * smooth01(score, 40);         // ã‚¹ã‚³ã‚¢40ä»˜è¿‘ã§åŠåˆ†ç¨‹åº¦
}
/* ã‚¹ãƒãƒ¼ãƒ³çŸ­ç¸®ï¼ˆå¾ã€…ã«çŸ­ããƒ»ä¸‹é™ã‚ã‚Šï¼‰ */
function spawnMillis(score){
  const t = smooth01(score, 50);                      // 0â†’1ã¸ç·©ã‚„ã‹
  const min = Math.max(CFG.spawnMinLimit, CFG.spawnMin - 300*t);
  const max = CFG.spawnMax - 300*t*0.7;
  return {min, max: Math.max(min+60, max)};
}

/* ========= å¤‰æ•° ========= */
let score=0, misses=0, elapsed=0;
let apples=[], particles=[];
let slashTrail=[], recentSegments=[];
let spawnTimer=0, nextSpawn=600;
let lastCutAt=0, combo=0;

/* ========= åˆæœŸåŒ– ========= */
function initGameObjects(){
  score=0; misses=0; elapsed=0;
  apples.length=particles.length=slashTrail.length=recentSegments.length=0;
  spawnTimer=0; nextSpawn=pickNextSpawn(); lastCutAt=0; combo=0;
}
function onResize(){}

/* ========= ä¹±æ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const rand=(a,b)=>a+Math.random()*(b-a);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ========= ã‚¹ãƒãƒ¼ãƒ³ ========= */
function safeSpawnX(halfR){
  const margin = Math.max(CFG.sideMargin, halfR + 8);
  return rand(margin, viewW - margin);
}
function pickNextSpawn(){
  const {min, max} = spawnMillis(score);
  return min + Math.random()*(max - min);
}
function spawnApple(){
  const r = rand(CFG.sizeMin, CFG.sizeMax);
  const x = safeSpawnX(r);
  const vScale = speedScale(score, CFG.vyMaxBoost); // åˆé€Ÿã®ç·©ã‚„ã‹ãªå€ç‡
  const vy = rand(CFG.baseVyMin, CFG.baseVyMax) * vScale;
  const vx = (Math.random()*2-1) * CFG.vxRand;
  const ang = rand(0,Math.PI*2);
  const spin= rand(CFG.spinMin, CFG.spinMax);
  apples.push({x, y:-r-14, r, vx, vy, ang, spin, cut:false});
}

/* ========= å…¥åŠ›ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—â†’ç·šåˆ†ï¼‰ ========= */
let pointerDown=false, lastPt=null;
function canvasPos(e){
  const rect=canvas.getBoundingClientRect();
  return {x:(e.clientX-rect.left), y:(e.clientY-rect.top)}; // CSS px
}
canvas.addEventListener('pointerdown',e=>{
  if(state!=='playing'){ return; } // ä¸Šã§é–‹å§‹å‡¦ç†æ¸ˆã¿
  pointerDown=true; lastPt=canvasPos(e);
  slashTrail.push({x:lastPt.x,y:lastPt.y,t:performance.now()});
});
canvas.addEventListener('pointermove',e=>{
  if(!pointerDown||state!=='playing') return;
  const p=canvasPos(e), now=performance.now();
  slashTrail.push({x:p.x,y:p.y,t:now});
  if(lastPt){
    recentSegments.push({ax:lastPt.x,ay:lastPt.y,bx:p.x,by:p.y,t:now});
    slashCheck(lastPt.x,lastPt.y,p.x,p.y, now);
  }
  lastPt=p;
});
addEventListener('pointerup',()=>{ pointerDown=false; lastPt=null; });

function segCircleHit(ax,ay,bx,by,cx,cy,r){
  const abx=bx-ax, aby=by-ay;
  const t = clamp(((cx-ax)*abx + (cy-ay)*aby) / (abx*abx+aby*aby||1), 0, 1);
  const px=ax+abx*t, py=ay+aby*t, dx=cx-px, dy=cy-py;
  return (dx*dx+dy*dy) <= r*r;
}
function slashCheck(ax,ay,bx,by, time){
  for(const a of apples){
    if(a.cut) continue;
    if(segCircleHit(ax,ay,bx,by,a.x,a.y,a.r*0.95)){ // å½“ã¦ã‚„ã™ã„å°‘ã—ç”˜ã‚åŠå¾„
      a.cut=true;
      combo = (time-lastCutAt<=CFG.comboWindow) ? (combo+1) : 1;
      lastCutAt=time;
      score += CFG.scoreBase * combo;
      updateHUD();
      spawnParticles(a.x,a.y,a.r);
    }
  }
}

/* ========= ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« ========= */
function spawnParticles(x,y,r){
  for(let i=0;i<CFG.particleN;i++){
    const ang=Math.random()*Math.PI*2, sp=rand(120,320);
    particles.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:rand(260,460)});
  }
}

/* ========= æ›´æ–° ========= */
function update(dt){
  elapsed += dt;

  // ã‚¹ãƒãƒ¼ãƒ³
  spawnTimer += dt*1000;
  if(spawnTimer>=nextSpawn){
    spawnTimer=0; nextSpawn=pickNextSpawn(); spawnApple();
  }

  // â˜… ãªã‚ã‚‰ã‹é‡åŠ›ï¼ˆå€ç‡ã¯ 1 â†’ 1+gravityMaxBoost ã«æ¼¸è¿‘ï¼‰
  const gScale = 1 + CFG.gravityMaxBoost * smooth01(score, 50);
  const gravity = CFG.gravityBase * gScale;

  // ãƒªãƒ³ã‚´ã®ç§»å‹•
  for(let i=apples.length-1;i>=0;i--){
    const a=apples[i];
    a.vy += gravity*dt;
    a.x  += a.vx*dt;
    a.y  += a.vy*dt;
    a.ang+= a.spin*dt;

    // ç«¯ã®è·³ã­è¿”ã‚Šï¼ˆç”»é¢å¤–ã«å‡ºã•ãªã„ï¼‰
    const half = a.r;
    if(a.x < half + CFG.sideMargin){
      a.x = half + CFG.sideMargin; a.vx = Math.abs(a.vx) * CFG.bounceDampen;
    }else if(a.x > viewW - (half + CFG.sideMargin)){
      a.x = viewW - (half + CFG.sideMargin); a.vx = -Math.abs(a.vx) * CFG.bounceDampen;
    }

    // ç”»é¢ä¸‹ã¸è½ä¸‹
    if(a.y - a.r > viewH){
      if(!a.cut){
        misses++; updateHUD();
        if(misses>=CFG.maxMiss){ toGameOver(); }
      }
      apples.splice(i,1);
    }
  }

  // ç·šåˆ†/è»Œè·¡ã®å¯¿å‘½
  const now=performance.now();
  while(recentSegments.length && now - recentSegments[0].t > CFG.segmentKeepMs) recentSegments.shift();
  while(slashTrail.length    && now - slashTrail[0].t    > CFG.trailFadeMs)    slashTrail.shift();

  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.vx*=0.985; p.vy=(p.vy+900*dt)*0.985;
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt*1000;
    if(p.life<=0) particles.splice(i,1);
  }
}

/* ========= æç”» ========= */
function render(){
  ctx.clearRect(0,0,viewW,viewH);

  // ğŸ ãƒªãƒ³ã‚´
  for(const a of apples){ drawApple(a.x,a.y,a.r,a.ang,a.cut); }

  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆèµ¤ã€œã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰
  for(const p of particles){
    const alpha = Math.max(0, Math.min(1, p.life/460));
    ctx.fillStyle = `rgba(239,68,68,${alpha})`;
    ctx.beginPath(); ctx.arc(p.x, p.y, 2.2, 0, Math.PI*2); ctx.fill();
  }

  // æ–¬æ’ƒ
  if(slashTrail.length>1){
    ctx.lineWidth = CFG.sliceWidth;
    for(let i=1;i<slashTrail.length;i++){
      const a=slashTrail[i-1], b=slashTrail[i];
      const aAlpha = Math.max(0,1 - (performance.now()-a.t)/CFG.trailFadeMs);
      const bAlpha = Math.max(0,1 - (performance.now()-b.t)/CFG.trailFadeMs);
      const alpha = Math.max(0, Math.min(1,(aAlpha+bAlpha)/2));
      ctx.strokeStyle = `rgba(239,68,68,${alpha})`;
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    }
  }
}

/* ========= ãƒªãƒ³ã‚´æç”» ========= */
function drawApple(cx,cy,r,ang,isCut){
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(ang*0.4); // ã»ã‚“ã®å°‘ã—å›è»¢ï¼ˆå›ã‚Šã™ããªã„ï¼‰

  // å½±
  ctx.fillStyle = 'rgba(0,0,0,.06)';
  ctx.beginPath(); ctx.ellipse(4,6, r*0.9, r*0.4, 0, 0, Math.PI*2); ctx.fill();

  // æœ¬ä½“ï¼ˆã‚„ã‚„ç¸¦é•·ã®å††ï¼‰
  ctx.beginPath();
  ctx.ellipse(0,0, r*0.95, r*1.05, 0, 0, Math.PI*2);
  ctx.fillStyle   = isCut ? 'rgba(239,68,68,.55)' : 'var(--apple)';
  ctx.strokeStyle = 'var(--appleEdge)';
  ctx.lineWidth   = Math.max(2, r*0.12);
  ctx.fill(); ctx.stroke();

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  ctx.fillStyle = 'rgba(255,255,255,.28)';
  ctx.beginPath();
  ctx.ellipse(-r*0.35, -r*0.25, r*0.28, r*0.18, -0.5, 0, Math.PI*2);
  ctx.fill();

  // ãƒ˜ã‚¿
  ctx.strokeStyle = 'var(--stem)';
  ctx.lineWidth = Math.max(2, r*0.12);
  ctx.beginPath();
  ctx.moveTo(0,-r*0.95); ctx.quadraticCurveTo(r*0.1,-r*1.35, r*0.22,-r*1.1);
  ctx.stroke();

  // è‘‰
  ctx.fillStyle = 'var(--leaf)';
  ctx.beginPath();
  ctx.ellipse(r*0.36, -r*1.05, r*0.35, r*0.2, 0.8, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();
}

/* ========= HUD ========= */
function updateHUD(){
  scoreEl.textContent = String(score);
  missEl.textContent  = String(misses);
}

/* ========= ãƒ«ãƒ¼ãƒ— ========= */
function loop(t){
  const dt = Math.min(32, t - lastT)/1000 || 0; lastT=t;
  if(state==='playing'){ update(dt); }
  render();
  requestAnimationFrame(loop);
}

/* ========= èµ·å‹• ========= */
function onResize(){}
fullReset();
requestAnimationFrame(loop);
</script>
</body>
</html>